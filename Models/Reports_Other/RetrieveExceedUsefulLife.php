<?php
	require '../../Models/Connection/connection_token.php';

	$result = $db->prepare("SELECT `reissueID`, `reissueDate` FROM `tblreissue` `tblres` WHERE `tblres`.`DateCreated` = (SELECT MIN(`DateCreated`) FROM `tblreissue` WHERE `parentID` = `tblres`.`parentID`  AND `reissueDate` = (SELECT MIN(`reissueDate`) FROM `tblreissue` INNER JOIN `tblreissuedet` ON `tblreissuedet`.`reissuedetID` = `tblreissue`.`parentID`  INNER JOIN  `tblsupplydesc` ON `tblsupplydesc`.`descID` = `tblreissuedet`.`descID` INNER JOIN `tblchartaccount` ON `tblchartaccount`.`chartID` = `tblsupplydesc`.`chartID_Acc` WHERE `parentID` = `tblres`.`parentID` AND `reissueStatus` != 5 AND `reissueStatus` != 4 AND TRIM(LOWER(SUBSTRING(`chartLife`, LENGTH(`chartLife`)-4, (LENGTH(`chartLife`)-(LENGTH(`chartLife`)-4))+1))) = 'year'AND CONCAT(IF((FLOOR(ABS(((DATE(NOW()) - DATE(`reissueDate`))/100)-(YEAR(NOW()) - YEAR(`reissueDate`))*100))) != 0 AND YEAR(NOW()) - YEAR(`reissueDate`) != 0, YEAR(NOW()) - YEAR(`reissueDate`)-1, YEAR(NOW()) - YEAR(`reissueDate`)), '.', FLOOR(ABS(((DATE(NOW()) - DATE(`reissueDate`))/100)-(YEAR(NOW()) - YEAR(`reissueDate`))*100)) ) >= CAST(TRIM(LOWER(SUBSTRING(`chartLife`, 1, (LENGTH(`chartLife`)-4)))) as DECIMAL(11,2)) )) UNION ALL SELECT `reissueID`, `reissueDate` FROM `tblreissue` `tblres` WHERE `tblres`.`DateCreated` = (SELECT MIN(`DateCreated`) FROM `tblreissue` WHERE `parentID` = `tblres`.`parentID`  AND `reissueDate` = (SELECT MIN(`reissueDate`) FROM `tblreissue` INNER JOIN `tblreissuedet` ON `tblreissuedet`.`reissuedetID` = `tblreissue`.`parentID`  INNER JOIN  `tblsupplydesc` ON `tblsupplydesc`.`descID` = `tblreissuedet`.`descID` INNER JOIN `tblchartaccount` ON `tblchartaccount`.`chartID` = `tblsupplydesc`.`chartID_Acc` WHERE `parentID` = `tblres`.`parentID` AND `reissueStatus` != 5 AND `reissueStatus` != 4 AND TRIM(LOWER(SUBSTRING(`chartLife`, LENGTH(`chartLife`)-5, (LENGTH(`chartLife`)-(LENGTH(`chartLife`)-5))+1))) = 'month'AND (FLOOR(ABS(((DATE(NOW()) - DATE(`reissueDate`))/100)-(YEAR(NOW()) - YEAR(`reissueDate`))*100))) + (ROUND((ABS(((DATE(NOW()) - DATE(`reissueDate`))/100)-(YEAR(NOW()) - YEAR(`reissueDate`))*100)),2)) + (((YEAR(NOW()) - YEAR(`reissueDate`))*100)/100)*12 >= CAST(TRIM(LOWER(SUBSTRING(`chartLife`, 1, (LENGTH(`chartLife`)-5)))) as DECIMAL(11,2)) )) UNION ALL SELECT `reissueID`, `reissueDate` FROM `tblreissue` `tblres` WHERE `tblres`.`DateCreated` = (SELECT MIN(`DateCreated`) FROM `tblreissue` WHERE `parentID` = `tblres`.`parentID`  AND `reissueDate` = (SELECT MIN(`reissueDate`) FROM `tblreissue` INNER JOIN `tblreissuedet` ON `tblreissuedet`.`reissuedetID` = `tblreissue`.`parentID`  INNER JOIN  `tblsupplydesc` ON `tblsupplydesc`.`descID` = `tblreissuedet`.`descID` INNER JOIN `tblchartaccount` ON `tblchartaccount`.`chartID` = `tblsupplydesc`.`chartID_Acc` WHERE `parentID` = `tblres`.`parentID` AND `reissueStatus` != 5 AND `reissueStatus` != 4 AND TRIM(LOWER(SUBSTRING(`chartLife`, LENGTH(`chartLife`)-3, (LENGTH(`chartLife`)-(LENGTH(`chartLife`)-3))+1))) = 'day'AND FLOOR((ROUND((ABS(((DATE(NOW()) - DATE(`reissueDate`))/100)-(YEAR(NOW()) - YEAR(`reissueDate`))*100)),2))*100)+ (((YEAR(NOW()) - YEAR(`reissueDate`))*100)/100)*365 >= CAST(TRIM(LOWER(SUBSTRING(`chartLife`, 1, (LENGTH(`chartLife`)-3)))) as DECIMAL(11,2)) ))"); $result->execute();
	while($rowDate = $result->fetch()){
		$result = $db->prepare("SELECT IFNULL(`icsCode`, `pareCode`) as `issueCode`, `supplyName`, `reissueProperty`, `accountName` FROM `tblreissue` LEFT JOIN `tblicsdet` ON `tblicsdet`.`icsdetID` = `tblreissue`.`icsdetID` LEFT JOIN `tblics` ON `tblics`.`icsID` = `tblicsdet`.`icsID` LEFT JOIN `tblparedet` ON `tblparedet`.`paredetID` = `tblreissue`.`paredetID` LEFT JOIN `tblpare` ON `tblpare`.`pareID` = `tblparedet`.`pareID` INNER JOIN `tblreissuedet` ON `tblreissuedet`.`reissuedetID` = `tblreissue`.`parentID` INNER JOIN `tblaccount` ON `tblaccount`.`accountID` = `tblreissue`.`employeeID` INNER JOIN `tblsupply` ON `tblsupply`.`supplyID` = `tblreissue`.`supplyID` WHERE `reissueStatus` != 5 AND `reissueStatus` != 4 AND `tblreissue`.`reissueID` = :ID");
		$result->execute([":ID" => $rowDate["reissueID"]]);
		while($row = $result->fetch()){
			$arrayExceed[] = array("message" => "success", 'Code' => $row["issueCode"], 'Supply' => $row["supplyName"], 'Property' => $row["reissueProperty"], 'Employee' => $row["accountName"], 'FirstDate' => $rowDate["reissueDate"]);
		}
	}

	jsEncode($arrayExceed);
?>